# NBT格式

**NBT（二进制命名标签**，**N**amed **B**inary **T**ags**）** 格式为Minecraft中用于向文件中存储数据的一种存储格式。NBT格式以树形结构并配以许多*标签*的形式存储数据。所有的标签都有一个独立的ID和名称。

本项目提供了可以读写minecraft nbt文件的类。

![示意图](https://i.loli.net/2020/10/18/AS6da4f5UPWtcV9.png)


## 标签的定义

每一个标签在数据树中都是一个独立的部分。标签的第一个字节为标签类型（ID）,其后两字节为存储名称的长度,之后以UTF-8格式的字符串的方式存储标签。尽管在默认的情况下Minecraft本身并不会存储带有空格的名称，但是标签名称*可以*包含空格。最后，取决于标签的类型，之后的字节为该标签的*辅助信息*。下表所示为在19133标签版本中二进制命名标签格式中所有13个已知的标签类型：

|   ID   |        标签类型        |                           辅助信息                           | SNBT格式‌‌[仅[Java版](https://minecraft-zh.gamepedia.com/Java版)] |                             描述                             |
| :----: | :--------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| **0**  |      TAG_**End**       |                              无                              |                              -                               | 用于标记复合标签的结尾。本标签**无任何名称**所以只有一个零字节。 |
| **1**  |      TAG_**Byte**      |                     1字节 / 8位，有正负                      |                   `<number>b`或`<number>B`                   |          有正负的整值数据类型，通常用于布尔表达式。          |
| **2**  |     TAG_**Short**      |               2字节 / 16位，有正负，字节序：BE               |                   `<number>s`或`<number>S`                   |                    有正负的整值数据类型。                    |
| **3**  |      TAG_**Int**       |              4 字节 / 32 位，有正负，字节序：BE              |                          `<number>`                          |                    有正负的整值数据类型。                    |
| **4**  |      TAG_**Long**      |              8 字节 / 64 位，有正负，字节序：BE              |                   `<number>l`或`<number>L`                   |                    有正负的整值数据类型。                    |
| **5**  |     TAG_**Float**      | 4 字节 / 32 位，有正负，字节序：BE，IEEE 754-2008标准，binary32。 |                   `<number>f`或`<number>F`                   |                    有正负的浮点数据类型。                    |
| **6**  |     TAG_**Double**     | 8 字节 / 64 位，有正负，字节序：BE，IEEE 754-2008标准，binary64。 |         `<decimal number>`、`<number>d`或`<number>D`         |                    有正负的浮点数据类型。                    |
| **7**  | TAG_**Byte**_**Array** |    TAG_Int的辅助信息*大小*以及 TAG_Byte的辅助信息*大小*。    |                   `[B;<byte>,<byte>,...]`                    |                            数组。                            |
| **8**  |     TAG_**String**     | 前2个字节(TAG_Short)存储字符串字符的长度。然后是以UTF-8标准存储的字符串，因为拥有长度，因此没有空结束符。 | `<a-zA-Z0-9 text>`、`"<text>"`（`"`需使用`\"`转义）或`'<text>'`（`'`需使用`\'`转义） |                  32,767字节会以UTF-8解析。                   |
| **9**  |      TAG_**List**      | 辅助信息的第1个字节(TAG_Byte)存储列表标签类型的ID,接下来的4个字节(TAG_Int)存储列表的size,接下来的字节将存储size个列表标签类型的辅助信息.假如第一个字节是0x08,id是8,对应的标签是TAG_String,如果size是0x00000004,接下来将会存储4个TAG_String标签的辅助信息。列表标签(既然都说了是列表)存储的内容都是相同类型的标签,所以只在第一个字节表明标签类型. |                   `[<value>,<value>,...]`                    |          一系列没有重复标签ID和标签名称的辅助信息。          |
| **10** |    TAG_**Compound**    |               标签的完整形式，需要附加TAG_End                |        `{<tag name>:<value>,<tag name>:<value>,...}`         | 一系列完整的标签信息，包括ID、名称以及辅助信息等。任意两个标签都不会有相同的名称。 |
| **11** | TAG_**Int**_**Array**  | 辅助信息前4个字节(TAG_Int)用于存储数组的大小size,紧接size*4 字节(TAG_Int)的数组数据.占用存储空间: 4+4**size Byte*。 |                `[I;<integer>,<integer>,...]`                 |                存储TAG_Int的辅助信息的数组。                 |
| **12** | TAG_**Long**_**Array** | 辅助信息前4个字节(TAG_Int)用于存储数组的大小size，紧接size*8 字节(TAG_Long)的数组数据。占用存储空间: 4+8**size Byte*。 |                   `[L;<long>,<long>,...]`                    |                存储TAG_Long的辅助信息的数组。                |

复合标签的列表常以嵌套递归的方式出现。另外还需注意，在一个包含List的List中，每个List可以包含不同类型的数据。



## 文件格式

NBT文件是经过GZip压缩的复合标签，其中包括名称和标签ID。在Minecraft中使用的文件有可能未经压缩，但是基于Notch最初的叙述，文件需要经GZip进行压缩。文件中并没有用于显示版本及其他信息的头文件，只是在[level.dat](https://minecraft-zh.gamepedia.com/Level.dat)中才出现这一显示版本的内容。



## 在Minecraft中的应用

NBT文件格式在Minecraft的应用不尽相同。在某些情况下，空目录可能不会表示字节标签列表而表示为一系列正确标签类型的列表。额外的，几乎所有的根标签均包含一个空字符串并包含一个复合标签存储实际的数据和名称，如下所示：

-   在Minecraft NBT结构中最常看到的根标签。
    -    **SomeName**: 在根标签下的唯一一个标签——这一标签拥有名称和实际的数据。

另一点值得注意的是，尽管Notch最初所述允许在标签名称中出现空格，甚至是在例子中也出现了包含空格的标签名称，但是Minecraft并不会识别带有空格的标签名称。使用大小写字母混排也会造成不稳定，推荐使用小驼峰(lowerCamelCase)和大驼峰(UpperCamelCase)的命名规则，有时甚至可以使用全部小写字母的方式。

### 应用

-   [level.dat](https://minecraft-zh.gamepedia.com/Level.dat)以压缩后的NBT格式进行存储。
-   [.dat](https://minecraft-zh.gamepedia.com/Player.dat格式)以压缩后的NBT格式进行存储。
-   idcounts.dat以未压缩的NBT格式进行存储。
-   map_<#>.dat以压缩后的NBT格式进行存储。
-   Servers.dat以未压缩的NBT格式进行存储多人服务器列表。
-   [区块](https://minecraft-zh.gamepedia.com/区块格式)以压缩后的NBT格式进行存储[区域](https://minecraft-zh.gamepedia.com/区域文件格式)文件。
